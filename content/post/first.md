---
title: "redo log, bin log理解"
date: 2020-08-28T17:03:31+08:00
draft: false
tags: ["mysql"]


---



##  redo log （事务日志）

​      表数据在磁盘里相当于酒店的赊账总账本，账本太大了，避免每次客人来消费都要翻找账本修改的麻烦。可以先把客人这次的消费记录到一个粉板上，每次客人来都只需要把当前消费先记录到粉板上，就不需要找账本了，等空闲或者打烊的时候再把修改同步到账本就可以了。

​	他的关键点事先写日志（磁盘上的一小块区域的顺序io），再写磁盘（随机io）。也就是先记粉板，等不忙的时候再记账本。    

​	粉板和账本配合的这个过程，其实就是mysql中常说的WAL技术（Write-Ahead Logging）。事务日志采用的是追加的方式，因此写日志操作，是磁盘上的一小块区域的顺序io，而不像随机io需要在磁盘的多个地方移动磁头，所以采用事务日志的方式相对来说要快很多。事务日志持久以后，内存中被修改的数据再后台可以慢慢的刷回磁盘。WAL技术修改数据的时候修改要写两次磁盘。

​	如果数据的修改以及记录到事务日志并持久化，但数据本身还没有写回磁盘，此时系统崩溃，存储引擎也可以在重启时候根据事务日志来恢复这部分的数据。

​	



## bin log （归档日志）

​	  bin log 是mysql 的server层的的日志，bin log 日志用来记录对数据的修改，这样可以根据bin log 来做备份还原，主从复制。

​	bin log的记录方式有三种：

1. 基于语句的复制（statement）

   优点：更少的日志空间 ，复制快。

   缺点：不能确保数据的正确复制，例如存储过程中函数的处理，delete limit语句没有使用order by，删除的数据可以不一致等等

2. 基于行的复制（默认）（row）

   优点：任何改变都可以写入日志，也是最安全的方式。

   缺点：日志文件更大，复制起来麻烦，一个批量修改会产生多条日志。

3. 混合方式



## redo log 和bin log的不同

- redo log是InnoDB引擎特有的；bin log是MySQl的Server层是实现的，所有的引擎都可以使用。
- redo log是物理日志，记录的是“某行记录做了什么改动”；bin log是逻辑日志记录的是这语句的原始逻辑（有一种statement 记的sql语句）
- redo log是循环写入的，固定空间会用完；bin log是追加写入的。“追加写”是指bin log文件写到一定大小后回切换到下一个，不会覆盖以前的日志。 



## update语句的流程图

图中浅色框表示是在InnoDB内部执行的，深色框表示在执行器中执行的。

![img](https://tva1.sinaimg.cn/large/007S8ZIlly1gia4u5zeudj30u013zdr4.jpg)

redo log 事务日志的两段式提交：prepare 和commit  

- 假如redo log先写入成功，而binlog 后写入失败，从库是根据binlog来复制的，这有可能出现主库和从库数据不一致。
- 假如bin log先写入成功，后redo log写入失败的话，此时系统崩溃，redo log 还没有写入，恢复数据时候这个事务无效。但是bin log 中却存在这一行记录，之后使用bin log的时候就会多出一个事务来，与原库不一致。

redo log和bin log 都可以表示事务的提交状态，而两段式的提交就是让这两个状态保持逻辑上的一致。 